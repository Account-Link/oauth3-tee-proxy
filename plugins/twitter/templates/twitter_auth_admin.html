{% extends "base.html" %}
{% import "macros.html" as ui %}

{% block title %}Twitter Authentication - OAuth3 TEE Proxy{% endblock %}

{% block page_title %}Twitter Authentication{% endblock %}

{% block content %}
<div class="container-xl">
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                <li class="nav-item">
                    <a href="#cookie-tab" class="nav-link active" data-bs-toggle="tab">Cookie Authentication</a>
                </li>
                <li class="nav-item">
                    <a href="#oauth-tab" class="nav-link" data-bs-toggle="tab">OAuth Authentication</a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane active show" id="cookie-tab">
                    <h3 class="card-title">Add Twitter Account using Cookie</h3>
                    <div class="mb-4">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">1</span>
                                    </div>
                                    <div class="col">
                                        Log in to <a href="https://twitter.com" target="_blank">Twitter</a> in your browser
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">2</span>
                                    </div>
                                    <div class="col">
                                        Open your browser's Developer Tools:
                                        <ul class="mb-0 mt-1">
                                            <li>Chrome/Edge: Press F12 or right-click anywhere and select "Inspect"</li>
                                            <li>Firefox: Press F12 or right-click and select "Inspect Element"</li>
                                            <li>Safari: First enable Developer Tools in Safari Preferences > Advanced, then press Command+Option+I</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">3</span>
                                    </div>
                                    <div class="col">
                                        Navigate to the Storage/Application section:
                                        <ul class="mb-0 mt-1">
                                            <li>Chrome/Edge: Click on the "Application" tab</li>
                                            <li>Firefox: Click on the "Storage" tab</li>
                                            <li>Safari: Click on the "Storage" tab</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">4</span>
                                    </div>
                                    <div class="col">
                                        Find and expand the "Cookies" section, then click on "https://twitter.com"
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">5</span>
                                    </div>
                                    <div class="col">
                                        Find the cookie named <code>auth_token</code> in the list and copy its value (just the value, not the name)
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">6</span>
                                    </div>
                                    <div class="col">
                                        <strong>TL;DR:</strong> Paste the <code>auth_token</code> value below. You can paste just the value, or include the prefix <code>auth_token=</code>.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <div class="d-flex">
                            <div>
                                <i class="ti ti-info-circle icon alert-icon"></i>
                            </div>
                            <div>
                                <h4>Security note:</h4>
                                <div>Your Twitter cookie is sensitive information. This proxy will store this cookie in a secure environment to access Twitter on your behalf. The cookie is only used to make authorized API calls to Twitter.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Twitter auth_token Cookie:</label>
                                <textarea id="twitter_cookie" class="form-control" rows="4" placeholder="Paste your auth_token value here (must be the actual token value)" required></textarea>
                                <div class="form-hint mt-1">
                                    <strong>Required format:</strong> The auth_token cookie value - a string of alphanumeric characters<br>
                                    <strong class="text-danger">⚠️ Important:</strong> Make sure you're copying just the <code>auth_token</code> cookie's value, not other cookies. This is a long text string that may vary in length.
                                </div>
                            </div>
                            
                            <div id="cookieSubmitStatus" class="alert" style="display: none;"></div>
                            
                            <div class="mt-3">
                                <button onclick="submitCookie()" class="btn btn-primary" type="button">Submit Cookie</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane" id="oauth-tab">
                    <h3 class="card-title">Add Twitter Account using OAuth</h3>
                    <div class="mb-4">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">1</span>
                                    </div>
                                    <div class="col">
                                        Click the "Connect with Twitter" button below
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">2</span>
                                    </div>
                                    <div class="col">
                                        You will be redirected to Twitter's authorization page
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">3</span>
                                    </div>
                                    <div class="col">
                                        Log in to your Twitter account (if not already logged in)
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">4</span>
                                    </div>
                                    <div class="col">
                                        Authorize the OAuth3 TEE Proxy application to access your Twitter account
                                    </div>
                                </div>
                            </div>
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <span class="badge bg-primary">5</span>
                                    </div>
                                    <div class="col">
                                        After authorization, you will be redirected back to the dashboard with your Twitter account linked
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <div class="d-flex">
                            <div>
                                <i class="ti ti-info-circle icon alert-icon"></i>
                            </div>
                            <div>
                                <h4>Authorization Info:</h4>
                                <div>OAuth is the recommended method for linking your Twitter account. When you authorize the application, you grant it permission to make API calls on your behalf. You can revoke this access at any time from your Twitter account settings.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-body">
                            <div id="oauthSubmitStatus" class="alert" style="display: none;"></div>
                            
                            <div class="mt-3">
                                <a href="/twitter/oauth/link?next=/dashboard" class="btn btn-twitter">
                                    <i class="ti ti-brand-twitter me-2"></i>
                                    Connect with Twitter
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer">
            <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
        </div>
    </div>
</div>

<style>
    .btn-twitter {
        background-color: #1DA1F2;
        color: white;
    }
    
    .btn-twitter:hover {
        background-color: #0c85d0;
        color: white;
    }
</style>

<script>
    async function submitCookie() {
        // Get the cookie value
        let cookieValue = document.getElementById('twitter_cookie').value.trim();
        
        if (!cookieValue) {
            showCookieStatus('Please enter a Twitter cookie.', 'alert-danger');
            return;
        }
        
        // Do not mess with the cookie format - just submit what the user entered directly
        
        // Show debug information - first 10 chars only for security
        const previewChars = cookieValue.substring(0, 10);
        console.log(`Submitting cookie value starting with: ${previewChars}..., length: ${cookieValue.length}`);
        
        // Show loading state
        showCookieStatus('Submitting cookie...', 'alert-info');
        
        try {
            // Submit via API with the raw value
            const response = await fetch('/twitter/auth/cookies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    cookie: cookieValue
                })
            });
            
            // Parse the response
            if (response.ok) {
                try {
                    const data = await response.json();
                    console.log('Server response:', data);
                    
                    if (data.account && data.account.username) {
                        showCookieStatus(`Successfully linked Twitter account: @${data.account.username}`, 'alert-success');
                    } else {
                        showCookieStatus('Successfully linked Twitter account!', 'alert-success');
                    }
                    
                    // Redirect to dashboard after a short delay
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                } catch (e) {
                    console.error('Error parsing JSON response:', e);
                    showCookieStatus('Successfully linked Twitter account!', 'alert-success');
                    
                    // Redirect to dashboard after a short delay
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 1500);
                }
            } else {
                // Handle error response
                let errorMsg = 'Failed to submit cookie.';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorMsg;
                } catch (e) {
                    // If we can't parse the JSON, use the status text
                    errorMsg = response.statusText || errorMsg;
                }
                showCookieStatus(errorMsg, 'alert-danger');
            }
        } catch (error) {
            console.error('Error submitting cookie:', error);
            showCookieStatus('Network error. Please try again.', 'alert-danger');
        }
    }
    
    function showCookieStatus(message, type) {
        const statusElement = document.getElementById('cookieSubmitStatus');
        statusElement.innerHTML = message;
        statusElement.className = 'alert';
        statusElement.classList.add(type);
        statusElement.style.display = 'block';
    }
</script>
{% endblock %}