{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="auth-container">
  <h1>Register with Passkey</h1>
  
  <p class="auth-intro">
    Create a new account using a passkey. No password required! You can add your username and other details later.
  </p>
  
  <form id="register-form" class="auth-form">
    <div class="form-group">
      <label for="username">Username (optional)</label>
      <input type="text" id="username" name="username" class="form-control">
      <small class="form-text text-muted">You can set this later in your profile if you prefer.</small>
    </div>
    
    <div class="form-group">
      <label for="display-name">Display Name (optional)</label>
      <input type="text" id="display-name" name="display_name" class="form-control">
    </div>
    
    <div class="form-group">
      <label for="device-name">Device Name (optional)</label>
      <input type="text" id="device-name" name="device_name" class="form-control" placeholder="e.g., iPhone, Work Laptop">
      <small class="form-text text-muted">A name to identify this device in your account.</small>
    </div>
    
    <button type="submit" class="btn btn-primary" id="register-button">Register with Passkey</button>
    
    <div class="form-message" id="register-message"></div>
  </form>
  
  <div class="auth-links">
    <p>Already have an account? <a href="/auth/login">Login with Passkey</a></p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const registerForm = document.getElementById('register-form');
  const registerButton = document.getElementById('register-button');
  const registerMessage = document.getElementById('register-message');
  
  registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    registerButton.disabled = true;
    registerMessage.textContent = 'Starting registration...';
    
    try {
      // Get form data
      const usernameInput = document.getElementById('username');
      const displayNameInput = document.getElementById('display-name');
      const deviceNameInput = document.getElementById('device-name');
      
      const username = usernameInput.value.trim();
      const displayName = displayNameInput.value.trim();
      const deviceName = deviceNameInput.value.trim();
      
      // Start registration
      const startResponse = await fetch('/auth/register/begin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username || null,
          display_name: displayName || null
        })
      });
      
      if (!startResponse.ok) {
        const error = await startResponse.json();
        throw new Error(error.detail || 'Failed to start registration');
      }
      
      const options = await startResponse.json();
      
      // Convert base64 strings to ArrayBuffer
      options.challenge = base64urlToArrayBuffer(options.challenge);
      options.user.id = base64urlToArrayBuffer(options.user.id);
      if (options.excludeCredentials) {
        options.excludeCredentials = options.excludeCredentials.map(cred => {
          return {
            ...cred,
            id: base64urlToArrayBuffer(cred.id)
          };
        });
      }
      
      // Create credential in browser
      registerMessage.textContent = 'Please follow your browser\'s instructions to create a passkey...';
      const credential = await navigator.credentials.create({
        publicKey: options
      });
      
      // Prepare credential for sending to server
      const regCredential = {
        id: credential.id,
        rawId: arrayBufferToBase64url(credential.rawId),
        type: credential.type,
        response: {
          clientDataJSON: arrayBufferToBase64url(credential.response.clientDataJSON),
          attestationObject: arrayBufferToBase64url(credential.response.attestationObject)
        },
        transports: credential.response.getTransports ? credential.response.getTransports() : []
      };
      
      // Complete registration
      registerMessage.textContent = 'Completing registration...';
      
      const formData = new FormData();
      formData.append('credential', JSON.stringify(regCredential));
      if (deviceName) {
        formData.append('device_name', deviceName);
      }
      
      const completeResponse = await fetch('/auth/register/complete', {
        method: 'POST',
        body: formData
      });
      
      if (!completeResponse.ok) {
        const error = await completeResponse.json();
        throw new Error(error.detail || 'Failed to complete registration');
      }
      
      const result = await completeResponse.json();
      
      if (result.success) {
        registerMessage.textContent = 'Registration successful! Redirecting...';
        window.location.href = result.redirect || '/profile';
      } else {
        throw new Error('Registration failed');
      }
      
    } catch (error) {
      registerMessage.textContent = 'Error: ' + error.message;
      console.error('Registration error:', error);
    } finally {
      registerButton.disabled = false;
    }
  });
  
  // Helper functions for WebAuthn encoding/decoding
  function base64urlToArrayBuffer(base64url) {
    const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
    const padLen = (4 - (base64.length % 4)) % 4;
    const padded = base64 + '='.repeat(padLen);
    const binary = atob(padded);
    const buffer = new ArrayBuffer(binary.length);
    const bytes = new Uint8Array(buffer);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return buffer;
  }
  
  function arrayBufferToBase64url(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = '';
    for (let i = 0; i < bytes.byteLength; i++) {
      binary += String.fromCharCode(bytes[i]);
    }
    const base64 = btoa(binary);
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }
});
</script>
{% endblock %}