{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
  .passkey-animation {
    text-align: center;
    margin: 20px 0;
  }
  
  .passkey-icon {
    font-size: 3rem;
    animation: pulse 1.5s infinite ease-in-out;
    color: #28a745;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 0.5; }
  }
  
  .loading {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(40, 167, 69, 0.25);
    border-top-color: #28a745;
    border-radius: 50%;
    animation: spin 1s infinite linear;
    margin-right: 0.5rem;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .features-list {
    margin: 20px 0;
    padding-left: 20px;
  }
  
  .features-list li {
    margin-bottom: 10px;
    position: relative;
    padding-left: 28px;
  }
  
  .features-list li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #28a745;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
  <h1>Register with Passkey</h1>
  
  <p class="auth-intro">
    Create a new account using a passkey ‚Äî a more secure alternative to passwords.
    Passkeys are unique digital keys that are stored securely on your device.
  </p>
  
  <ul class="features-list">
    <li>No password to remember or reset</li>
    <li>Works across your devices</li>
    <li>More secure than passwords</li>
    <li>Complete your profile after registration</li>
  </ul>
  
  <form id="register-form" class="auth-form">
    <div class="form-group">
      <label for="username">Username (optional)</label>
      <input type="text" id="username" name="username" class="form-control">
      <small class="form-text text-muted">You can set this later in your profile if you prefer.</small>
    </div>
    
    <div class="form-group">
      <label for="display-name">Display Name (optional)</label>
      <input type="text" id="display-name" name="display_name" class="form-control">
    </div>
    
    <div class="form-group">
      <label for="device-name">Device Name</label>
      <input type="text" id="device-name" name="device_name" class="form-control" placeholder="e.g., iPhone, Work Laptop">
      <small class="form-text text-muted">A name to identify this device in your account.</small>
    </div>
    
    <div class="passkey-animation" id="passkey-animation" style="display: none;">
      <div class="passkey-icon">üîê</div>
      <p>Create your passkey</p>
    </div>
    
    <button type="submit" class="btn btn-success btn-lg btn-block" id="register-button">
      <span id="button-text">Register with Passkey</span>
      <span id="button-loading" style="display: none;"><span class="loading"></span>Processing...</span>
    </button>
    
    <div class="form-message" id="register-message"></div>
  </form>
  
  <div class="auth-links">
    <p>Already have an account? <a href="/auth/login">Login with Passkey</a></p>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/webauthn-helper.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const registerForm = document.getElementById('register-form');
  const registerButton = document.getElementById('register-button');
  const registerMessage = document.getElementById('register-message');
  const passkeyAnimation = document.getElementById('passkey-animation');
  const buttonText = document.getElementById('button-text');
  const buttonLoading = document.getElementById('button-loading');
  
  // Set default device name if empty
  const deviceNameInput = document.getElementById('device-name');
  if (!deviceNameInput.value) {
    // Try to detect device type
    const userAgent = navigator.userAgent;
    let deviceName = "My Device";
    
    if (/iPhone|iPad|iPod/.test(userAgent)) {
      deviceName = "My iPhone";
      if (/iPad/.test(userAgent)) deviceName = "My iPad";
      if (/iPod/.test(userAgent)) deviceName = "My iPod";
    } else if (/Android/.test(userAgent)) {
      deviceName = "My Android Device";
    } else if (/Windows/.test(userAgent)) {
      deviceName = "My Windows PC";
    } else if (/Mac/.test(userAgent)) {
      deviceName = "My Mac";
    } else if (/Linux/.test(userAgent)) {
      deviceName = "My Linux PC";
    }
    
    deviceNameInput.value = deviceName;
  }
  
  function showLoading(message) {
    buttonText.style.display = 'none';
    buttonLoading.style.display = 'inline';
    registerButton.disabled = true;
    registerMessage.textContent = message;
  }
  
  function hideLoading() {
    buttonText.style.display = 'inline';
    buttonLoading.style.display = 'none';
    registerButton.disabled = false;
  }
  
  function showError(message) {
    registerMessage.textContent = message;
    registerMessage.style.color = '#dc3545';
    hideLoading();
  }
  
  function showSuccess(message) {
    registerMessage.textContent = message;
    registerMessage.style.color = '#28a745';
  }
  
  registerForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    showLoading('Starting registration...');
    
    try {
      // Get form data
      const usernameInput = document.getElementById('username');
      const displayNameInput = document.getElementById('display-name');
      const deviceNameInput = document.getElementById('device-name');
      
      const username = usernameInput.value.trim();
      const displayName = displayNameInput.value.trim();
      const deviceName = deviceNameInput.value.trim();
      
      if (!deviceName) {
        showError('Please enter a device name');
        return;
      }
      
      // Start registration
      const startResponse = await fetch('/auth/register/begin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: username || null,
          display_name: displayName || null
        })
      });
      
      if (!startResponse.ok) {
        const error = await startResponse.json();
        throw new Error(error.detail || 'Failed to start registration');
      }
      
      const options = await startResponse.json();
      
      // Show passkey animation
      passkeyAnimation.style.display = 'block';
      
      // Prepare options for the browser
      const preparedOptions = WebAuthnHelper.prepareRegistrationOptions(options);
      
      // Create credential in browser
      registerMessage.textContent = 'Please follow your browser\'s instructions to create a passkey...';
      const credential = await navigator.credentials.create({
        publicKey: preparedOptions
      });
      
      // Hide passkey animation
      passkeyAnimation.style.display = 'none';
      
      // Prepare credential for sending to server
      const serverCredential = WebAuthnHelper.prepareCredentialForServer(credential);
      
      // Complete registration
      showLoading('Completing registration...');
      
      const formData = new FormData();
      formData.append('credential', JSON.stringify(serverCredential));
      formData.append('device_name', deviceName);
      
      const completeResponse = await fetch('/auth/register/complete', {
        method: 'POST',
        body: formData
      });
      
      if (!completeResponse.ok) {
        const error = await completeResponse.json();
        throw new Error(error.detail || 'Failed to complete registration');
      }
      
      const result = await completeResponse.json();
      
      if (result.success) {
        showSuccess('Registration successful! Redirecting...');
        
        // Add smooth redirect with delay
        setTimeout(() => {
          window.location.href = result.redirect || '/profile';
        }, 1500);
      } else {
        throw new Error('Registration failed');
      }
      
    } catch (error) {
      // Hide passkey animation
      passkeyAnimation.style.display = 'none';
      showError('Error: ' + error.message);
      console.error('Registration error:', error);
    }
  });
});
</script>
{% endblock %}