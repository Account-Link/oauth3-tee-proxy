{% extends "base.html" %}

{% block title %}Login with Passkey - OAuth3 TEE Proxy{% endblock %}
{% block page_title %}Login with Passkey{% endblock %}

{% block extra_js %}
<script>
    // Base64URL encoder and decoder helpers
    function base64urlDecode(input) {
        // Convert base64url to base64
        input = input.replace(/-/g, '+').replace(/_/g, '/');
        // Add padding if needed
        const pad = input.length % 4;
        if (pad) {
            input += '='.repeat(4 - pad);
        }
        return atob(input);
    }
    
    function base64urlEncode(buffer) {
        // Convert ArrayBuffer to base64
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        // Convert base64 to base64url
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    async function startAuthentication() {
        try {
            const username = document.getElementById('username').value;

            if (!username) {
                alert('Username is required');
                return;
            }

            const statusElement = document.getElementById('login-status');
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Initializing authentication...';
            statusElement.classList.remove('d-none');
            
            // Get authentication options from server
            console.log(`Sending login request with username: ${username}`);
            
            const optionsResponse = await fetch('/auth/login/begin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username
                })
            });

            if (!optionsResponse.ok) {
                const error = await optionsResponse.json();
                throw new Error(error.detail || 'Failed to get authentication options');
            }

            const options = await optionsResponse.json();
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Verifying passkey...';
            
            // Convert base64url strings to ArrayBuffer
            options.challenge = Uint8Array.from(base64urlDecode(options.challenge), c => c.charCodeAt(0));
            
            if (options.allowCredentials) {
                options.allowCredentials = options.allowCredentials.map(cred => ({
                    ...cred,
                    id: Uint8Array.from(base64urlDecode(cred.id), c => c.charCodeAt(0))
                }));
            }

            // Get credentials
            const credential = await navigator.credentials.get({
                publicKey: options
            });

            // Convert ArrayBuffer to base64url for sending to server
            const credentialResponse = {
                credential: {
                    id: credential.id,
                    rawId: base64urlEncode(credential.rawId),
                    response: {
                        authenticatorData: base64urlEncode(credential.response.authenticatorData),
                        clientDataJSON: base64urlEncode(credential.response.clientDataJSON),
                        signature: base64urlEncode(credential.response.signature),
                        userHandle: credential.response.userHandle ? base64urlEncode(credential.response.userHandle) : null,
                    },
                    type: credential.type
                },
                client_data: base64urlEncode(credential.response.clientDataJSON)
            };

            console.log("Sending credential response:", credentialResponse);

            // Send response to server
            const verificationResponse = await fetch('/auth/login/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(credentialResponse)
            });

            if (!verificationResponse.ok) {
                const errorData = await verificationResponse.json();
                throw new Error(errorData.detail || 'Failed to verify authentication');
            }

            const result = await verificationResponse.json();
            statusElement.innerHTML = '<div class="alert alert-success">Login successful! Redirecting to dashboard...</div>';
            
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1500);
        } catch (error) {
            console.error('Authentication error:', error);
            document.getElementById('login-status').innerHTML = 
                `<div class="alert alert-danger">Login failed: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Login with Passkey</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required" for="username">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Enter your username" required>
                </div>
                <div id="login-status" class="mb-3 d-none"></div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="/auth/register" class="btn btn-link">Don't have an account? Register</a>
                <button class="btn btn-primary" onclick="startAuthentication()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-login" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                        <path d="M20 12h-13l3 -3m0 6l-3 -3"></path>
                    </svg>
                    Login
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}