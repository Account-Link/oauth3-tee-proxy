{% extends "base.html" %}

{% block title %}Login with Passkey - OAuth3 TEE Proxy{% endblock %}
{% block page_title %}Login with Passkey{% endblock %}

{% block extra_js %}
<script>
    // Base64URL encoder and decoder helpers
    function base64urlDecode(input) {
        // Convert base64url to base64
        input = input.replace(/-/g, '+').replace(/_/g, '/');
        // Add padding if needed
        const pad = input.length % 4;
        if (pad) {
            input += '='.repeat(4 - pad);
        }
        return atob(input);
    }
    
    function base64urlEncode(buffer) {
        // Convert ArrayBuffer to base64
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        // Convert base64 to base64url
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }
    
    async function startAuthentication() {
        try {
            const username = document.getElementById('username').value;

            if (!username) {
                alert('Username is required');
                return;
            }

            const statusElement = document.getElementById('login-status');
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Initializing authentication...';
            statusElement.classList.remove('d-none');
            
            // Get authentication options from server
            console.log(`Sending login request with username: ${username}`);
            
            const optionsResponse = await fetch('/auth/login/begin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username
                })
            });

            if (!optionsResponse.ok) {
                const errorData = await optionsResponse.json();
                console.error("Authentication options error:", errorData);
                throw new Error(errorData.detail || 'Failed to get authentication options');
            }

            let options;
            try {
                // The response is already a JSON string from the server
                // We need to handle it as text and then parse it
                const optionsText = await optionsResponse.text();
                console.log("Raw options response:", optionsText);
                options = JSON.parse(optionsText);
                console.log("Parsed authentication options:", options);
                
                // Validate we have required fields
                if (!options.challenge) {
                    console.error("Missing challenge in options");
                    throw new Error("Authentication challenge is missing in server response");
                }
                
                if (!options.allowCredentials || !Array.isArray(options.allowCredentials) || options.allowCredentials.length === 0) {
                    console.error("Missing or invalid allowCredentials in options");
                    throw new Error("No valid credentials found for this user");
                }
            } catch (parseError) {
                console.error("Error parsing options:", parseError);
                throw new Error("Failed to parse authentication options: " + parseError.message);
            }
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Verifying passkey...';
            
            // Convert base64url strings to ArrayBuffer
            if (options.challenge) {
                options.challenge = Uint8Array.from(base64urlDecode(options.challenge), c => c.charCodeAt(0));
            } else {
                console.error("Challenge is missing in options");
                throw new Error("Authentication challenge is missing");
            }
            
            if (options.allowCredentials) {
                options.allowCredentials = options.allowCredentials.map(cred => {
                    if (!cred || !cred.id) {
                        console.error("Invalid credential in allowCredentials:", cred);
                        throw new Error("Invalid credential format");
                    }
                    return {
                        ...cred,
                        id: Uint8Array.from(base64urlDecode(cred.id), c => c.charCodeAt(0))
                    };
                });
            } else {
                console.log("No allowCredentials in options");
            }

            // Verify options has the right structure for WebAuthn
            console.log("About to call navigator.credentials.get with options:", options);
            
            // Remove any unexpected properties that might cause issues
            const publicKeyOptions = {
                challenge: options.challenge,
                rpId: options.rpId,
                timeout: options.timeout || 60000,
                allowCredentials: options.allowCredentials,
                userVerification: options.userVerification || 'preferred'
            };
            
            console.log("Final publicKey options:", publicKeyOptions);
            
            // Get credentials
            try {
                console.log("Calling navigator.credentials.get...");
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyOptions
                });
                console.log("Got credential response:", credential);

                // Convert ArrayBuffer to base64url for sending to server
                const credentialResponse = {
                    credential: {
                        id: credential.id,
                        rawId: base64urlEncode(credential.rawId),
                        response: {
                            authenticatorData: base64urlEncode(credential.response.authenticatorData),
                            clientDataJSON: base64urlEncode(credential.response.clientDataJSON),
                            signature: base64urlEncode(credential.response.signature),
                            userHandle: credential.response.userHandle ? base64urlEncode(credential.response.userHandle) : null,
                        },
                        type: credential.type
                    },
                    client_data: base64urlEncode(credential.response.clientDataJSON)
                };

                console.log("Sending credential response:", credentialResponse);

                // Send response to server
                const verificationResponse = await fetch('/auth/login/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(credentialResponse)
                });

                if (!verificationResponse.ok) {
                    const errorData = await verificationResponse.json();
                    throw new Error(errorData.detail || 'Failed to verify authentication');
                }

                const result = await verificationResponse.json();
                statusElement.innerHTML = '<div class="alert alert-success">Login successful! Redirecting to dashboard...</div>';
                
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 1500);
        } catch (error) {
            console.error('Authentication error:', error);
            document.getElementById('login-status').innerHTML = 
                `<div class="alert alert-danger">Login failed: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Login with Passkey</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required" for="username">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Enter your username" required>
                </div>
                <div id="login-status" class="mb-3 d-none"></div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="/auth/register" class="btn btn-link">Don't have an account? Register</a>
                <button class="btn btn-primary" onclick="startAuthentication()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-login" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M14 8v-2a2 2 0 0 0 -2 -2h-7a2 2 0 0 0 -2 2v12a2 2 0 0 0 2 2h7a2 2 0 0 0 2 -2v-2"></path>
                        <path d="M20 12h-13l3 -3m0 6l-3 -3"></path>
                    </svg>
                    Login
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}