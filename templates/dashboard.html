{% extends "base.html" %}
{% import "macros.html" as ui %}

{% block title %}Dashboard - OAuth3 TEE Proxy{% endblock %}
{% block page_title %}Welcome, {{ user.username }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        {% if plugin_actions %}
            {% for action in plugin_actions %}
                {{ action|safe }}
            {% endfor %}
        {% endif %}
    </div>
</div>

{# Available Plugins Section #}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Available Plugins</h3>
            </div>
            <div class="card-body">
                {% if available_plugins and available_plugins.items() %}
                    <div class="row row-cards">
                        {% for plugin_name, plugin_info in available_plugins.items() %}
                            <div class="col-md-6">
                                <div class="card" data-plugin="{{ plugin_name }}">
                                    <div class="card-header" 
                                        {% if plugin_info.color %}
                                            style="background-color: {{ plugin_info.color }}; color: white;"
                                        {% elif plugin_name == "twitter" %}
                                            style="background-color: #1DA1F2; color: white;"
                                        {% elif plugin_name == "telegram" %}
                                            style="background-color: #0088cc; color: white;"
                                        {% endif %}>
                                        <h3 class="card-title" style="color: white;">{{ plugin_name|title }} Plugin</h3>
                                    </div>
                                    <div class="card-body">
                                        {% if plugin_info.description %}
                                            <p>{{ plugin_info.description }}</p>
                                        {% else %}
                                            <p>Provides integration with {{ plugin_name|title }} services.</p>
                                        {% endif %}
                                        
                                        {% if plugin_info.features %}
                                            <div class="mb-3">
                                                <h4 class="card-subtitle">Features</h4>
                                                <ul class="list-group list-group-flush mt-2">
                                                    {% for feature in plugin_info.features %}
                                                        <li class="list-group-item">{{ feature }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                        
                                        {# Integrated Twitter Accounts Section #}
                                        {% if plugin_name == "twitter" %}
                                            <div class="mb-3">
                                                <h4 class="card-subtitle">Your Accounts {% if plugin_info.account_count and plugin_info.account_count > 0 %}({{ plugin_info.account_count }}){% endif %}</h4>
                                                
                                                {% if plugin_info.accounts_html is defined %}
                                                    {{ plugin_info.accounts_html|safe }}
                                                {% else %}
                                                    <p class="text-muted">No Twitter accounts linked yet.</p>
                                                {% endif %}
                                                
                                                <div class="d-flex gap-2 mt-3">
                                                    <a href="/twitter/auth/admin" class="btn btn-primary">Add Twitter Account</a>
                                                    {% if plugin_info.account_count and plugin_info.account_count > 0 %}
                                                        <button onclick="deleteAllTwitterAccounts()" class="btn btn-danger">Delete All</button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if plugin_info.urls %}
                                            <div class="d-flex flex-wrap gap-2">
                                                {% for label, url in plugin_info.urls.items() %}
                                                    <a href="{{ url }}" class="btn btn-outline-primary" {% if label == "Documentation" %}target="_blank"{% endif %}>{{ label }}</a>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">No plugins currently available.</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">OAuth2 Access Tokens</h3>
            </div>
            <div class="card-body">
                {% if oauth2_tokens %}
                    <div class="table-responsive">
                        <table class="table table-vcenter card-table">
                            <thead>
                                <tr>
                                    <th>Token ID</th>
                                    <th>Scopes</th>
                                    <th>Created</th>
                                    <th>Expires</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for token in oauth2_tokens %}
                                    <tr>
                                        <td>{{ token.id[:8] }}...</td>
                                        <td>
                                            {% if token.scopes %}
                                                {% for scope in token.scopes.split() %}
                                                    <span class="badge bg-blue me-1">{{ scope }}</span>
                                                {% endfor %}
                                            {% else %}
                                                <span class="badge bg-secondary">No scopes</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ token.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if token.expires_at %}
                                                {{ token.expires_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% else %}
                                                Never
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex gap-2">
                                                {% if token.token %}
                                                    <button onclick="copyToken('{{ token.token }}')" class="btn btn-sm btn-outline-primary">
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copy" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                            <rect x="8" y="8" width="12" height="12" rx="2"></rect>
                                                            <path d="M16 8v-2a2 2 0 0 0 -2 -2h-8a2 2 0 0 0 -2 2v8a2 2 0 0 0 2 2h2"></path>
                                                        </svg>
                                                        Copy
                                                    </button>
                                                {% endif %}
                                                <button onclick="revokeToken('{{ token.id }}')" class="btn btn-sm btn-outline-danger">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-trash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                                        <line x1="4" y1="7" x2="20" y2="7"></line>
                                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                                        <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12"></path>
                                                        <path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3"></path>
                                                    </svg>
                                                    Revoke
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No active OAuth2 tokens.</p>
                {% endif %}

                <div class="mt-4">
                    <h4>Create New Token</h4>
                    <form onsubmit="createToken(event)">
                        <div class="mb-3">
                            <label class="form-label">Select Scopes</label>
                            <select id="tokenScopes" class="form-select" multiple required>
                                {% for scope in available_scopes %}
                                    <option value="{{ scope }}">{{ scope }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-hint">Hold Ctrl/Cmd to select multiple scopes</div>
                        </div>
                        <button type="submit" class="btn btn-primary">Create Token</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function createToken(event) {
        event.preventDefault();
        const scopes = Array.from(document.getElementById('tokenScopes').selectedOptions)
            .map(option => option.value)
            .join(' ');
        
        try {
            const response = await fetch('/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `scopes=${encodeURIComponent(scopes)}`
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to create token');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating token');
        }
    }

    async function revokeToken(tokenId) {
        if (!confirm('Are you sure you want to revoke this token?')) return;
        try {
            const response = await fetch(`/token/${tokenId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to revoke token');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error revoking token');
        }
    }

    function copyToken(token) {
        navigator.clipboard.writeText(token).then(() => {
            alert('Token copied to clipboard!');
        }).catch(err => {
            console.error('Error copying token:', err);
            alert('Failed to copy token');
        });
    }

    async function refreshChannels(accountId) {
        try {
            const response = await fetch('/telegram/channels');
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to refresh channels');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error refreshing channels');
        }
    }
    
    async function deleteTwitterAccount(twitterId) {
        if (!confirm('Are you sure you want to delete this Twitter account?')) return;
        
        try {
            // Show loading indicator
            const accountItem = document.querySelector(`.account-item[data-twitter-id="${twitterId}"]`);
            if (accountItem) {
                accountItem.classList.add('deleting');
            }
            
            const response = await fetch(`/twitter/accounts/${twitterId}`, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                try {
                    // Try to parse JSON
                    const data = await response.json();
                    if (accountItem) {
                        // Animate removal
                        accountItem.style.height = `${accountItem.offsetHeight}px`;
                        accountItem.style.opacity = '1';
                        setTimeout(() => {
                            accountItem.style.height = '0';
                            accountItem.style.opacity = '0';
                            accountItem.style.padding = '0';
                            accountItem.style.margin = '0';
                            setTimeout(() => {
                                accountItem.remove();
                                
                                // If no accounts left, refresh to update UI
                                const remainingAccounts = document.querySelectorAll('.plugin-account-list .account-item');
                                if (remainingAccounts.length === 0) {
                                    window.location.reload();
                                }
                            }, 300);
                        }, 10);
                    } else {
                        window.location.reload();
                    }
                } catch (e) {
                    // If not JSON, likely a redirect response
                    window.location.href = response.redirected ? response.url : '/dashboard';
                }
            } else {
                // Handle error response
                let errorMsg = 'Failed to delete Twitter account';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorMsg;
                } catch (e) {
                    // If not JSON
                    errorMsg = response.statusText || errorMsg;
                }
                alert(errorMsg);
                if (accountItem) {
                    accountItem.classList.remove('deleting');
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error deleting Twitter account');
            
            const accountItem = document.querySelector(`.account-item[data-twitter-id="${twitterId}"]`);
            if (accountItem) {
                accountItem.classList.remove('deleting');
            }
        }
    }
    
    async function deleteAllTwitterAccounts() {
        if (!confirm('Are you sure you want to delete ALL your Twitter accounts? This action cannot be undone.')) return;
        
        // Double confirmation for dangerous action
        if (!confirm('CAUTION: This will remove all Twitter accounts from your profile. Press OK to continue.')) return;
        
        try {
            // Show loading state
            const accountItems = document.querySelectorAll('.plugin-account-list .account-item');
            accountItems.forEach(item => item.classList.add('deleting'));
            
            const response = await fetch('/twitter/accounts', {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                try {
                    // Try to get JSON response
                    const data = await response.json();
                    
                    // Animate removal of all accounts
                    accountItems.forEach(item => {
                        item.style.height = `${item.offsetHeight}px`;
                        item.style.opacity = '1';
                        setTimeout(() => {
                            item.style.height = '0';
                            item.style.opacity = '0';
                            item.style.padding = '0';
                            item.style.margin = '0';
                        }, 10);
                    });
                    
                    // Reload after animation
                    setTimeout(() => {
                        window.location.reload();
                    }, 400);
                    
                } catch (e) {
                    // If not JSON, likely a redirect
                    window.location.href = response.redirected ? response.url : '/dashboard';
                }
            } else {
                // Handle error
                let errorMsg = 'Failed to delete all Twitter accounts';
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.detail || errorMsg;
                } catch (e) {
                    errorMsg = response.statusText || errorMsg;
                }
                alert(errorMsg);
                accountItems.forEach(item => item.classList.remove('deleting'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error deleting Twitter accounts');
            
            const accountItems = document.querySelectorAll('.plugin-account-list .account-item');
            accountItems.forEach(item => item.classList.remove('deleting'));
        }
    }
</script>
{% endblock %}