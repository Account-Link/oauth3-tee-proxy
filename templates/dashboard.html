{% extends "base.html" %}
{% import "macros.html" as ui %}

{% block title %}Dashboard - OAuth3 TEE Proxy{% endblock %}

{% block page_title %}Welcome, {{ user.username }}{% endblock %}

{% block header %}
<header class="main-header d-flex justify-content-between align-items-center">
    <h1 class="page-title">{{ self.page_title() }}</h1>
    <div class="header-actions">
        {{ ui.button('Twitter GraphQL Playground', '/graphql-playground', 'button', 'link', '', 'background-color: #1DA1F2;') }}
    </div>
</header>
{% endblock %}

{% block content %}
<div class="dashboard-section">
    <h2>Your Twitter Accounts</h2>
    {% if twitter_accounts %}
        <ul class="account-list">
            {% for account in twitter_accounts %}
                {{ ui.twitter_account_card(account) }}
            {% endfor %}
        </ul>
        <div class="button-group mt-3">
            {{ ui.button('Add Twitter Account', '/submit-cookie') }}
        </div>
    {% else %}
        <p>No Twitter accounts linked yet.</p>
        <div class="button-group mt-3">
            {{ ui.button('Add Twitter Account', '/submit-cookie') }}
        </div>
    {% endif %}
</div>

<div class="dashboard-section">
    <h2>Your Telegram Account</h2>
    {% if telegram_accounts %}
        <ul class="account-list">
            {% for account in telegram_accounts %}
                <li class="account-item">
                    <span>Phone: {{ account.phone_number }}</span>
                    <span>Added: {{ account.created_at.strftime('%Y-%m-%d') }}</span>
                    {{ ui.button('Refresh Channels', '#', 'delete-button', 'button', "refreshChannels('"+account.id+"')", '') }}
                </li>
                {% if account.channels %}
                    <ul class="channel-list">
                        {% for channel in account.channels %}
                            <li class="channel-item">
                                <span>{{ channel.name }}</span>
                                {% if channel.username %}
                                    <span>@{{ channel.username }}</span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No channels found.</p>
                {% endif %}
            {% endfor %}
        </ul>
    {% else %}
        <p>No Telegram account linked yet.</p>
    {% endif %}
    {{ ui.button('Add Telegram Account', '/add-telegram') }}
</div>

<div class="dashboard-section">
    <h2>OAuth2 Access Tokens</h2>
    {% if oauth2_tokens %}
        <ul class="token-list">
            {% for token in oauth2_tokens %}
                {{ ui.oauth_token_card(token) }}
            {% endfor %}
        </ul>
    {% else %}
        <p>No active OAuth2 tokens.</p>
    {% endif %}

    <form class="token-form" onsubmit="createToken(event)">
        <select id="tokenScopes" multiple required>
            {% for scope in available_scopes %}
                <option value="{{ scope }}">{{ scope }}</option>
            {% endfor %}
        </select>
        {{ ui.button('Create Token', '#', '', 'submit') }}
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function createToken(event) {
        event.preventDefault();
        const scopes = Array.from(document.getElementById('tokenScopes').selectedOptions)
            .map(option => option.value)
            .join(' ');
        
        try {
            const response = await fetch('/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `scopes=${encodeURIComponent(scopes)}`
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to create token');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error creating token');
        }
    }

    async function revokeToken(tokenId) {
        if (!confirm('Are you sure you want to revoke this token?')) return;
        try {
            const response = await fetch(`/token/${tokenId}`, {
                method: 'DELETE'
            });
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to revoke token');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error revoking token');
        }
    }

    function copyToken(token) {
        navigator.clipboard.writeText(token).then(() => {
            alert('Token copied to clipboard!');
        }).catch(err => {
            console.error('Error copying token:', err);
            alert('Failed to copy token');
        });
    }

    async function refreshChannels(accountId) {
        try {
            const response = await fetch('/telegram/channels');
            if (response.ok) {
                window.location.reload();
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to refresh channels');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error refreshing channels');
        }
    }
    
    async function deleteTwitterAccount(twitterId) {
        if (!confirm('Are you sure you want to delete this Twitter account?')) return;
        
        try {
            const response = await fetch(`/twitter/accounts/${twitterId}`, {
                method: 'DELETE'
            });
            
            if (response.ok || response.redirected) {
                window.location.href = response.redirected ? response.url : '/dashboard';
            } else {
                const error = await response.json();
                alert(error.detail || 'Failed to delete Twitter account');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting Twitter account');
        }
    }
</script>
{% endblock %}