{% extends "base.html" %}

{% block title %}Register with Passkey - OAuth3 TEE Proxy{% endblock %}
{% block page_title %}Register with Passkey{% endblock %}

{% block extra_js %}
<script>
    // Base64URL encoder and decoder helpers
    function base64urlDecode(input) {
        // Convert base64url to base64
        input = input.replace(/-/g, '+').replace(/_/g, '/');
        // Add padding if needed
        const pad = input.length % 4;
        if (pad) {
            input += '='.repeat(4 - pad);
        }
        return atob(input);
    }
    
    function base64urlEncode(buffer) {
        // Convert ArrayBuffer to base64
        const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
        // Convert base64 to base64url
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
    }

    async function startRegistration() {
        try {
            const username = document.getElementById('username').value;
            const displayName = document.getElementById('display_name').value;

            if (!username) {
                alert('Username is required');
                return;
            }

            const statusElement = document.getElementById('registration-status');
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Initializing registration...';
            statusElement.classList.remove('d-none');
            
            // Get registration options from server
            const optionsResponse = await fetch('/auth/register/begin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    username: username,
                    display_name: displayName
                })
            });

            if (!optionsResponse.ok) {
                const error = await optionsResponse.json();
                throw new Error(error.detail || 'Failed to get registration options');
            }

            const options = await optionsResponse.json();
            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Creating credentials...';
            
            // Convert base64url strings to ArrayBuffer
            options.user.id = Uint8Array.from(base64urlDecode(options.user.id), c => c.charCodeAt(0));
            options.challenge = Uint8Array.from(base64urlDecode(options.challenge), c => c.charCodeAt(0));

            // Create credentials
            const credential = await navigator.credentials.create({
                publicKey: options
            });

            statusElement.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Verifying registration...';
            
            // Convert ArrayBuffer to base64url for sending to server
            const credentialResponse = {
                credential: {
                    id: credential.id,
                    rawId: base64urlEncode(credential.rawId),
                    response: {
                        attestationObject: base64urlEncode(credential.response.attestationObject),
                        clientDataJSON: base64urlEncode(credential.response.clientDataJSON),
                    },
                    type: credential.type,
                    transports: credential.response.getTransports ? credential.response.getTransports() : [],
                },
                client_data: base64urlEncode(credential.response.clientDataJSON)
            };

            console.log("Sending credential response:", credentialResponse);
            console.log("Raw credential object:", credential);
            console.log("JSON stringified:", JSON.stringify(credentialResponse));

            // Send response to server
            const verificationResponse = await fetch('/auth/register/complete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(credentialResponse)
            });

            if (!verificationResponse.ok) {
                const errorData = await verificationResponse.json();
                throw new Error(errorData.detail || 'Failed to verify registration');
            }

            const result = await verificationResponse.json();
            statusElement.innerHTML = '<div class="alert alert-success">Registration successful! Redirecting to dashboard...</div>';
            
            setTimeout(() => {
                window.location.href = '/dashboard';
            }, 1500);
        } catch (error) {
            console.error('Registration error:', error);
            document.getElementById('registration-status').innerHTML = 
                `<div class="alert alert-danger">Registration failed: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6 mx-auto">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Register with Passkey</h3>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label required" for="username">Username</label>
                    <input type="text" class="form-control" id="username" placeholder="Choose a username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label" for="display_name">Display Name (optional)</label>
                    <input type="text" class="form-control" id="display_name" placeholder="Your display name">
                </div>
                <div id="registration-status" class="mb-3 d-none"></div>
            </div>
            <div class="card-footer d-flex justify-content-between">
                <a href="/auth/login" class="btn btn-link">Already have an account? Login</a>
                <button class="btn btn-primary" onclick="startRegistration()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-key" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l6.558 -6.558l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z"></path>
                        <path d="M15 9h.01"></path>
                    </svg>
                    Register with Passkey
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}