{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
  .passkey-animation {
    text-align: center;
    margin: 20px 0;
  }
  
  .passkey-icon {
    font-size: 3rem;
    animation: pulse 1.5s infinite ease-in-out;
    color: #007bff;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); opacity: 0.5; }
  }
  
  .loading {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(0, 123, 255, 0.25);
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 1s infinite linear;
    margin-right: 0.5rem;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
  <h1>Login with Passkey</h1>
  
  <p class="auth-intro">
    Securely log in to your account using your passkey. No password needed!
  </p>
  
  <form id="login-form" class="auth-form">
    <div class="form-group">
      <label for="username">Username (optional if using platform authenticator)</label>
      <input type="text" id="username" name="username" class="form-control">
      <small class="form-text text-muted">If you have passkeys on multiple accounts, enter your username.</small>
    </div>
    
    <div class="passkey-animation" id="passkey-animation" style="display: none;">
      <div class="passkey-icon">ðŸ”‘</div>
      <p>Use your passkey to log in</p>
    </div>
    
    <button type="submit" class="btn btn-primary btn-lg btn-block" id="login-button">
      <span id="button-text">Login with Passkey</span>
      <span id="button-loading" style="display: none;"><span class="loading"></span>Processing...</span>
    </button>
    
    <div class="form-message" id="login-message"></div>
  </form>
  
  <div class="auth-links">
    <p>Don't have an account? <a href="/auth/register">Register with Passkey</a></p>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/webauthn-helper.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const loginForm = document.getElementById('login-form');
  const loginButton = document.getElementById('login-button');
  const loginMessage = document.getElementById('login-message');
  const passkeyAnimation = document.getElementById('passkey-animation');
  const buttonText = document.getElementById('button-text');
  const buttonLoading = document.getElementById('button-loading');
  
  function showLoading(message) {
    buttonText.style.display = 'none';
    buttonLoading.style.display = 'inline';
    loginButton.disabled = true;
    loginMessage.textContent = message;
  }
  
  function hideLoading() {
    buttonText.style.display = 'inline';
    buttonLoading.style.display = 'none';
    loginButton.disabled = false;
  }
  
  function showError(message) {
    loginMessage.textContent = message;
    loginMessage.style.color = '#dc3545';
    hideLoading();
  }
  
  function showSuccess(message) {
    loginMessage.textContent = message;
    loginMessage.style.color = '#28a745';
  }
  
  loginForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    showLoading('Starting login process...');
    
    try {
      // Get username if provided
      const usernameInput = document.getElementById('username');
      const username = usernameInput.value.trim();
      
      // Start authentication
      const formData = new FormData();
      if (username) {
        formData.append('username', username);
      }
      
      // Show passkey animation
      passkeyAnimation.style.display = 'block';
      
      // Convert FormData to JSON for better compatibility
      const jsonData = { username: username };
      console.log("Sending login request with data:", jsonData);
      
      const startResponse = await fetch('/auth/login/begin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
      });
      
      if (!startResponse.ok) {
        const error = await startResponse.json();
        throw new Error(error.detail || 'Failed to start login');
      }
      
      const responseText = await startResponse.text();
      console.log("Raw response text:", responseText);
      
      // Pass the raw response text to the WebAuthnHelper
      // It will handle parsing if needed
      const preparedOptions = WebAuthnHelper.prepareAuthenticationOptions(responseText);
      
      // Get authentication from browser
      loginMessage.textContent = 'Please follow your browser\'s instructions to authenticate...';
      const credential = await navigator.credentials.get({
        publicKey: preparedOptions
      });
      
      // Hide passkey animation
      passkeyAnimation.style.display = 'none';
      
      // Prepare credential for sending to server
      const serverCredential = WebAuthnHelper.prepareCredentialForServer(credential);
      
      // Complete authentication
      showLoading('Verifying authentication...');
      const completeResponse = await fetch('/auth/login/complete', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          credential: serverCredential
        })
      });
      
      if (!completeResponse.ok) {
        const error = await completeResponse.json();
        throw new Error(error.detail || 'Failed to complete login');
      }
      
      const result = await completeResponse.json();
      
      if (result.success) {
        showSuccess('Login successful! Redirecting...');
        
        // Add smooth redirect with delay
        setTimeout(() => {
          window.location.href = result.redirect || '/profile';
        }, 1000);
      } else {
        throw new Error('Login failed');
      }
      
    } catch (error) {
      // Hide passkey animation
      passkeyAnimation.style.display = 'none';
      showError('Error: ' + error.message);
      console.error('Login error:', error);
    }
  });
});
</script>
{% endblock %}